---
import type { Experience } from '../../shared/payload-types'
import type { PaginatedResponse } from '../../shared/types'
import api from '../../shared/api'

const res = await api.get('api/experience?sort=-startDate')
const data = (await res.json()) as PaginatedResponse<Experience>
const experiences = data.docs

const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleDateString('en-US', {
    month: 'short',
    year: 'numeric'
  })
}

const calculateDuration = (startDate: string, endDate?: string | null, isCurrent?: boolean | null) => {
  const start = new Date(startDate)
  const end = endDate ? new Date(endDate) : new Date()

  const months = (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth())
  const years = Math.floor(months / 12)
  const remainingMonths = months % 12

  if (years === 0) {
    return `${remainingMonths} month${remainingMonths !== 1 ? 's' : ''}`
  } else if (remainingMonths === 0) {
    return `${years} year${years !== 1 ? 's' : ''}`
  } else {
    return `${years} year${years !== 1 ? 's' : ''} ${remainingMonths} month${remainingMonths !== 1 ? 's' : ''}`
  }
}

const getJobTypeBadge = (type?: string | null) => {
  if (!type) return null
  return {
    label: type.charAt(0).toUpperCase() + type.slice(1).replace('-', '-'),
    className: 'bg-bg-subtle text-text-secondary border border-border'
  }
}
---

<section id="experience" class="relative py-16 sm:py-24 lg:py-32 bg-bg overflow-hidden">
  <div class="relative z-10 max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="mb-10 sm:mb-16">
      <p class="text-xs font-medium tracking-widest text-text-tertiary mb-3">
        <span class="text-accent">//</span> experience
      </p>
      <h2 class="font-pixel text-base sm:text-lg md:text-2xl text-text-primary mb-4 sm:mb-6">
        <span class="text-accent">&gt;</span> Professional Experience
      </h2>
      <p class="text-xs sm:text-sm text-text-secondary max-w-3xl">
        My journey through different roles and companies, building expertise in full-stack development and AI engineering.
      </p>
    </div>

    <div class="max-w-4xl mx-auto">
      <div class="relative">
        <div class="absolute left-[3px] sm:left-[7px] top-0 bottom-0 w-px bg-border"></div>

        <div class="space-y-6 sm:space-y-8">
          {experiences.map((experience) => (
            <div class="relative flex items-start group">
              <div class="relative z-10 flex-shrink-0 text-text-tertiary group-hover:text-accent transition-colors text-xs sm:text-sm leading-none mt-1.5 sm:mt-1 hidden sm:block w-4">├──</div>
              <div class="relative z-10 flex-shrink-0 text-text-tertiary group-hover:text-accent transition-colors text-xs leading-none mt-1.5 sm:hidden w-2">├</div>

              <div class="ml-2 sm:ml-4 w-full min-w-0">
                <div class="bg-surface border border-border p-4 sm:p-6 hover:border-accent/30 transition-colors">
                  <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between mb-3 sm:mb-4 gap-2">
                    <div class="flex-1 min-w-0">
                      <div class="flex items-center gap-2 sm:gap-3 mb-1 flex-wrap">
                        <h3 class="font-pixel text-[0.5rem] sm:text-xs text-text-primary">
                          {experience.position}
                        </h3>
                        {experience.isCurrent && (
                          <span class="inline-flex items-center px-1.5 sm:px-2 py-0.5 text-[0.6rem] sm:text-xs font-medium bg-accent/10 text-accent border border-accent/30">
                            [CURRENT]
                          </span>
                        )}
                        {getJobTypeBadge(experience.type) && (
                          <span class={`inline-flex items-center px-1.5 sm:px-2 py-0.5 text-[0.6rem] sm:text-xs font-medium ${getJobTypeBadge(experience.type)?.className}`}>
                            [{getJobTypeBadge(experience.type)?.label}]
                          </span>
                        )}
                      </div>
                      <div class="flex items-center space-x-2 mb-2 flex-wrap">
                        {experience.websiteUrl ? (
                          <a
                            href={experience.websiteUrl}
                            target="_blank"
                            rel="noopener noreferrer"
                            class="text-xs sm:text-sm font-medium text-accent hover:text-accent-hover transition-colors"
                          >
                            {experience.company}
                          </a>
                        ) : (
                          <span class="text-xs sm:text-sm font-medium text-text-secondary">
                            {experience.company}
                          </span>
                        )}
                        <span class="text-text-tertiary">·</span>
                        <span class="text-text-secondary text-[0.65rem] sm:text-xs">
                          {experience.location}
                        </span>
                      </div>
                    </div>

                    <div class="sm:text-right flex-shrink-0">
                      <div class="text-[0.65rem] sm:text-xs font-medium text-text-secondary">
                        {formatDate(experience.startDate)} – {experience.isCurrent ? 'Present' : experience.endDate ? formatDate(experience.endDate) : 'Present'}
                      </div>
                      <div class="text-[0.6rem] sm:text-xs text-text-tertiary">
                        {calculateDuration(experience.startDate, experience.endDate, experience.isCurrent)}
                      </div>
                    </div>
                  </div>

                  <p class="text-text-secondary text-xs sm:text-sm mb-3 sm:mb-4 leading-relaxed">
                    {experience.description}
                  </p>

                  {experience.achievements && experience.achievements.length > 0 && (
                    <div class="mb-3 sm:mb-4">
                      <h4 class="text-[0.65rem] sm:text-xs font-medium text-text-primary mb-1.5 sm:mb-2">
                        <span class="text-accent">&gt;</span> key_achievements
                      </h4>
                      <ul class="space-y-1">
                        {experience.achievements.map((achievement) => (
                          <li class="text-[0.65rem] sm:text-xs text-text-secondary">
                            <span class="text-text-tertiary">-</span> {achievement.achievement}
                          </li>
                        ))}
                      </ul>
                    </div>
                  )}

                  {experience.technologies && experience.technologies.length > 0 && (
                    <div>
                      <h4 class="text-[0.65rem] sm:text-xs font-medium text-text-primary mb-1.5 sm:mb-2">
                        <span class="text-accent">&gt;</span> technologies
                      </h4>
                      <div class="flex flex-wrap gap-1 sm:gap-1.5">
                        {experience.technologies.map((tech) => (
                          <span class="px-1.5 sm:px-2 py-0.5 bg-bg text-text-secondary border border-border text-[0.6rem] sm:text-xs">
                            [{typeof tech.technology === 'object' && tech.technology ? tech.technology.name : 'Technology'}]
                          </span>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  </div>
</section>
